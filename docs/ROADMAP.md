# نقشه راه تبدیل «Life Manager» به اپ دسکتاپ آفلاین (Electron)

این سند مراحل دقیق و قابل اجرا برای آفلاین‌سازی کامل، بهبود امنیت داده‌ها (رمزنگاری سرتاسری)، یکپارچه‌سازی با Electron، و تولید خروجی نصبی ویندوز (exe) را مشخص می‌کند.

## اهداف
- اجرای ۱۰۰٪ آفلاین؛ بدون وابستگی به CDN، importmap، یا فونت‌های آنلاین.
- امنیت سطح شخصی: رمز عبور اصلی (Master Password)، رمزنگاری داده‌ها (AES-GCM)، پاک‌سازی کلیپ‌بورد، قفل خودکار.
- پایداری ذخیره‌سازی و مدیریت تصاویر در مقیاس شخصی.
- بسته‌بندی Electron با تنظیمات امنیتی مناسب و خروجی exe.

## اصول کلی
- عدم استفاده از منابع ریموت در Renderer.
- جداسازی مسئولیت‌ها: Renderer فقط UI؛ دسترسی فایل/سیستم از طریق IPC امن به Preload/Main.
- عدم ذخیره کلید خام روی دیسک؛ کلید هر بار از Master Password مشتق می‌شود.

---

## فاز 0: آفلاین‌سازی فرانت‌اند و استانداردسازی وابستگی‌ها
1) حذف وابستگی‌های آنلاین
   - حذف importmap و CDNها از `index.html` (React/Zustand/… محلی از npm). ✅
   - حذف/جایگزینی Google Fonts؛ استفاده از سیستم‌فونت یا فونت محلی. ✅
2) راه‌اندازی Tailwind به‌صورت محلی
   - نصب: `tailwindcss`, `postcss`, `autoprefixer`. ✅
   - ایجاد `tailwind.config.js`، `postcss.config.js`، و `index.css` با `@tailwind base; @tailwind components; @tailwind utilities;`. ✅
   - حذف `<script src="https://cdn.tailwindcss.com">`. ✅
3) معیار پذیرش فاز 0
   - اجرای پروژه بدون اینترنت (vite dev/preview) بدون خطا و بدون منابع ریموت. ✅

## فاز 1: لایه ذخیره‌سازی و مدیریت تصاویر
1) Storage Adapter (وب/Electron)
   - ایجاد ماژول انتزاعی برای عملیات: `get`, `set`, `remove`, `migrate`. (در حال انجام)
   - وب: استفاده از `localStorage`/`IndexedDB` (ترجیح IndexedDB برای داده‌های حجیم). ✅ ایجاد وب‌Adapter اولیه (`lib/storage.ts`) و اتصال استور PasswordManager به آن.
   - Electron: فایل رمزنگاری‌شده در `userData` (با همکاری فاز 2). (برنامه‌ریزی‌شده)
2) مدیریت تصاویر
   - وب: ذخیره Blob در IndexedDB و نگه‌داری reference/URL. ✅ ایجاد سرویس `lib/idb-images.ts` و اتصال در `PasswordManager.tsx` (ذخیره رفرنس و resolve در نمایش).
   - Electron: ذخیره در مسیر `userData/images` و نگه‌داری مسیر. (برنامه‌ریزی‌شده)
   - محدود کردن حجم/ابعاد تصویر و فشرده‌سازی اختیاری موقع آپلود. (برنامه‌ریزی‌شده)
3) معیار پذیرش فاز 1
   - جداسازی کامل UI از جزئیات ذخیره‌سازی؛ عدم رسیدن حجم به سقف `localStorage` با تصاویر. (بخشی محقق شده؛ تصاویر به IndexedDB منتقل شدند)

## فاز 2: امنیت و رمزنگاری سرتاسری
1) Master Password و مشتق کلید
   - جایگزینی ورود فعلی با Master Password. ✅ (LoginPage در features/auth پیاده‌سازی شده و کلید در حافظه نگه داشته می‌شود)
   - ذخیره فقط `salt` و پارامترهای KDF (PBKDF2). عدم ذخیره رمز/کلید خام. ✅
2) رمزنگاری داده‌ها (AES-GCM)
   - رمزنگاری payloadهای Password Manager، Phone Book، Daily Tasks، Smart Accountant، Settings. ✅ (encryptedStateStorage)
   - Web: `SubtleCrypto`؛ Electron: ماژول `crypto` در Main. (الکترون در فاز 3)
3) مهاجرت داده‌های موجود
   - خواندن داده‌های فعلی از ذخیره‌ساز قدیمی، رمزنگاری و انتقال به فرمت جدید. ✅ (سازگاری عقب‌رو در getItem: JSON قدیمی خوانده و در نوشتن بعدی رمز می‌شود)
   - قبل از مهاجرت: ایجاد Export بکاپ ساده (JSON رمزنگاری‌نشده جهت اضطرار، یا ترجیحاً رمزنگاری‌شده با Master Password). ⏳ (UI لازم)
4) سخت‌سازی تجربه امنیتی
   - قفل خودکار پس از عدم فعالیت (مثلاً 10 دقیقه)، پاک‌سازی کلید از حافظه. ⏳ (برنامه‌ریزی)
   - پاک‌سازی کلیپ‌بورد خودکار (مثلاً 20-30 ثانیه بعد از Copy Password). ⏳ (برنامه‌ریزی)
5) معیار پذیرش فاز 2
   - تمام داده‌های حساس در دیسک/Storage فقط به‌شکل رمزنگاری‌شده وجود داشته باشند. ✅
   - ورود/قفل/بازگشایی بدون خطا و بدون از دست‌دادن داده. ✅ (rehydrate بعد از Login، پاک‌سازی کلید در Logout)

## فاز 3: الکترونایز کردن پروژه
1) اسکلت Electron امن
   - فایل‌های `main` و `preload` با تنظیمات:
     - `contextIsolation: true`, `nodeIntegration: false`, `enableRemoteModule: false`.
     - محدود کردن `window.open` و ناوبری.
   - تعریف IPC امن برای عملیات مجاز: خواندن/نوشتن فایل رمزنگاری‌شده، مدیریت تصاویر، دسترسی مسیر `userData`، پاک‌سازی کلیپ‌بورد.
2) یکپارچه‌سازی با Vite
   - استفاده از `vite-plugin-electron` (یا معادل) برای dev/build هم‌زمان renderer + main.
3) معیار پذیرش فاز 3
   - اجرای اپ در محیط Electron (dev) با IPC امن و عدم ارجاع به منابع ریموت.

## فاز 4: بسته‌بندی و خروجی ویندوز
1) پیکربندی `electron-builder`
   - `appId`، `artifactName` (مثلاً `LifeManagerSetup-${version}.exe`)، آیکون `.ico`، هدف `nsis`.
   - حذف منابع ریموت، اضافه‌کردن CSP سخت‌گیرانه.
2) ساخت و تست آفلاین
   - ساخت exe، نصب روی ویندوز، تست کامل بدون اینترنت: بوت، ورود، خواندن/نوشتن داده، Import/Export رمزنگاری‌شده.
3) معیار پذیرش فاز 4
   - نصب و اجرای بدون اینترنت بدون ارورها و بدون نشت منابع ریموت.

## فاز 5: بهبودهای UX دسکتاپ (اختیاری)
- میانبرهای صفحه‌کلید (Ctrl+F جست‌وجو، Ctrl+L قفل)، سوییچر سریع بین بخش‌ها.
- تم تیره/روشن، تنظیمات زمان قفل خودکار.
- نمایش Tray و قفل سریع از Tray (در صورت تمایل).

## فاز 6: سخت‌سازی نهایی
- CSP سخت‌گیرانه، حذف کامل هر URL ریموت.
- عدم لاگ‌کردن اسرار، پاک‌سازی ارجاعات حساس در خطاها.
- بازبینی کارایی (اندازه دیتاست، واکنش‌پذیری UI، حجم باندل).

---

## نقشه زمان‌بندی پیشنهادی (Milestones)
- M1 (روز 1-2): فاز 0
- M2 (روز 3-5): فاز 1
- M3 (روز 6-9): فاز 2
- M4 (روز 10-12): فاز 3
- M5 (روز 13-14): فاز 4
- M6 (روز 15): فاز 5 و 6 (بازبینی نهایی)

> زمان‌بندی واقع‌گرا به حجم داده‌های فعلی و گزینه‌های رمزنگاری انتخابی بستگی دارد.

## ریسک‌ها و کاهش آن‌ها
- مهاجرت داده‌ها: قبل از هر تغییر بزرگ، Export پشتیبان.
- محدودیت فضای `localStorage`: انتقال تصاویر به IndexedDB/Electron files.
- فراموشی Master Password: افزودن Hint و امکان ساخت Backup Keyfile رمزنگاری‌شده.

## چک‌لیست اجرایی خلاصه
- [x] حذف CDN/importmap و فونت‌های آنلاین؛ Tailwind محلی.
- [x] وب: Storage Adapter + مدیریت تصاویر (idb-images) و اتصال به PasswordManager؛ EncryptedStateStorage پیاده‌سازی شد.
- [x] امنیت (وب): Master Password + KDF و نگهداری کلید فقط در حافظه؛ AES-GCM برای Password Manager, Phone Book, Daily Tasks, Smart Accountant, Settings.
- [x] Rehydrate بعد از Login و پاک‌سازی Master Key در Logout؛ عدم ورود خودکار پس از Refresh بدون کلید.
- [x] سازگاری عقب‌رو: خواندن JSONهای قدیمیِ بدون رمز و نوشتن به فرمت رمزنگاری‌شده.
- [ ] امنیت تکمیلی: قفل خودکار پس از عدم فعالیت + پاک‌سازی خودکار کلیپ‌بورد.
- [ ] مهاجرت/Export UI: بکاپ رمزنگاری‌شده/غیررمزنگاری‌شده پیش از مهاجرت نهایی.
- [ ] اسکلت Electron امن + IPC محدود و امن.
- [ ] ادغام با Vite و اسکریپت‌های dev/build.
- [ ] پیکربندی electron-builder و تولید exe.
- [ ] تست کامل آفلاین + سخت‌سازی نهایی.